<html>

<head>
  <title>Express</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      margin-top: 30px;
      color: #2c3e50;
    }
    #refreshBtn {
      display: block;
      margin: 20px auto 10px auto;
      padding: 10px 30px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #refreshBtn:hover {
      background: #217dbb;
    }
    #status {
      text-align: center;
      color: #888;
      margin-bottom: 10px;
    }
    #oilTable {
      margin: 0 auto;
      border-collapse: collapse;
      width: 90%;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #oilTable th, #oilTable td {
      border: 1px solid #e1e1e1;
      padding: 10px 8px;
      text-align: center;
    }
    #oilTable th {
      background: #2980b9;
      color: #fff;
      font-weight: bold;
    }
    #oilTable tr:nth-child(even) {
      background: #f2f8fc;
    }
    #oilTable tr:hover {
      background: #eaf6ff;
    }
  </style>
</head>

<body>
  <h1>中油歷史油價查詢</h1>
  <button id="refreshBtn">手動刷新油價</button>
  <p id="status"></p>
  <table id="oilTable" border="1" style="margin-top:20px; display:none;">
    <thead>
      <tr>
        <th id="dateHeader" style="cursor:pointer;">調價日期 <span id="sortIcon">▼</span></th>
        <th>92 無鉛汽油</th>
        <th>95 無鉛汽油</th>
        <th>98 無鉛汽油</th>
        <th>超級/高級柴油</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    let oilData = [];
    let sortDesc = true;
    function sortByDate() {
      oilData.sort((a, b) => {
        // 將民國年轉西元年排序
        const toAD = s => {
          const [y, m, d] = s.split('/').map(Number);
          return new Date(y + 1911, m - 1, d);
        };
        return sortDesc ? toAD(b.date) - toAD(a.date) : toAD(a.date) - toAD(b.date);
      });
    }
    function renderTable() {
      const tbody = document.querySelector('#oilTable tbody');
      tbody.innerHTML = '';
      oilData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.date}</td><td>${row.oil92}</td><td>${row.oil95}</td><td>${row.oil98}</td><td>${row.diesel}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('oilTable').style.display = oilData.length ? '' : 'none';
    }
    async function loadOilPrices() {
      document.getElementById('status').textContent = '載入中...';
      const res = await fetch('/api/oil-prices');
      oilData = await res.json();
      sortByDate();
      renderTable();
      document.getElementById('status').textContent = oilData.length ? '' : '查無資料';
    }
    document.getElementById('refreshBtn').onclick = async function() {
      document.getElementById('status').textContent = '刷新中...';
      await fetch('/api/oil-prices/refresh', { method: 'POST' });
      await loadOilPrices();
      document.getElementById('status').textContent = '刷新完成';
    };
    document.getElementById('dateHeader').onclick = function() {
      sortDesc = !sortDesc;
      document.getElementById('sortIcon').textContent = sortDesc ? '▼' : '▲';
      sortByDate();
      renderTable();
    };
    loadOilPrices();
  </script>
</body>
</html>
